# Copyright Statement:
#

LOCAL_PATH := $(call my-dir)

ifeq ($(TARGET_DEVICE),)
TARGET_DEVICE := $(TARGET_PRODUCT)
endif

# if WIFI_DRIVER_MODULE_PATH is set empty by device.mk,
# driver module will be loaded by rc file, not by framework
# in this case, driver makefile will refer to WIFI_DRIVER_MODULE_PATH_FOR_DRV
# for driver path location
ifeq ($(BOARD_MTK_ONE_IMAGE),true)

ifeq ($(WIFI_DRIVER_MODULE_PATH_76x3),)
WIFI_DRIVER_MODULE_PATH_IN_DRV_76x3 := $(WIFI_DRIVER_MODULE_PATH_FOR_DRV_76x3)
else
WIFI_DRIVER_MODULE_PATH_IN_DRV_76x3 := $(WIFI_DRIVER_MODULE_PATH_76x3)
endif

ifeq ($(WIFI_DRIVER_MODULE_NAME_76x3),)
WIFI_DRIVER_MODULE_NAME_IN_DRV_76x3 := $(WIFI_DRIVER_MODULE_NAME_FOR_DRV_76x3)
else
WIFI_DRIVER_MODULE_NAME_IN_DRV_76x3 := $(WIFI_DRIVER_MODULE_NAME_76x3)
endif

else # BOARD_MTK_ONE_IMAGE

ifeq ($(WIFI_DRIVER_MODULE_PATH),)
WIFI_DRIVER_MODULE_PATH_IN_DRV_76x3 := $(WIFI_DRIVER_MODULE_PATH_FOR_DRV)
else
WIFI_DRIVER_MODULE_PATH_IN_DRV_76x3 := $(WIFI_DRIVER_MODULE_PATH)
endif

ifeq ($(WIFI_DRIVER_MODULE_NAME),)
WIFI_DRIVER_MODULE_NAME_IN_DRV_76x3 := $(WIFI_DRIVER_MODULE_NAME_FOR_DRV)
else
WIFI_DRIVER_MODULE_NAME_IN_DRV_76x3 := $(WIFI_DRIVER_MODULE_NAME)
endif

endif # BOARD_MTK_ONE_IMAGE

include $(CLEAR_VARS)
WIFI_PROJ_CONFIG_FILE_76x3 := $(LOCAL_PATH)/config/$(TARGET_DEVICE).config


local_path_full := $(shell pwd)/$(LOCAL_PATH)
wifi_module_out_path := $(PRODUCT_OUT)$(WIFI_DRIVER_MODULE_PATH_IN_DRV_76x3)
wifi_module_target := $(wifi_module_out_path)
PRIVATE_DRIVER_OUT_DIR := $(PRODUCT_OUT)$(WIFI_DRIVER_MODULE_DIR)

#Default enable prealloc memory
CFG_MTK_PREALLOC_DRIVER := y

MTK_STRIP_DRIVER := y

LOCAL_KERNEL_CROSS_COMPILE_76x3 := $(KERNEL_CROSS_COMPILE)
# Due to compile error when doing stripe command for abc123/abc123/abc123/abc123, the cross_compile need to be redefined
ifeq ($(TARGET_BOARD_PLATFORM), $(filter m7322 m7632 m7332 mt5889, $(TARGET_BOARD_PLATFORM)))
LOCAL_KERNEL_CROSS_COMPILE_76x3 := $(ROOTDIR)/prebuilts/gcc/linux-x86/aarch64/linaro-aarch64_linux-2014.09/bin/aarch64-linux-gnu-
endif

#current parameter name for target arch on VSB is $(TARGET_ARCH)
ifeq ($(TARGET_KERNEL_ARCH),)
TARGET_KERNEL_ARCH_76x3 := $(TARGET_ARCH)
else
TARGET_KERNEL_ARCH_76x3 := $(TARGET_KERNEL_ARCH)
endif

#avoid $(KERNEL_OUT)is not defined
ifeq ($(KERNEL_OUT),)
KERNEL_OUT := $(PRODUCT_OUT)/obj/KERNEL_OBJ
endif

LOCAL_MODULE := $(WIFI_DRIVER_MODULE_NAME_IN_DRV_76x3)
LOCAL_MODULE_TAGS := optional
LOCAL_ADDITIONAL_DEPENDENCIES := $(wifi_module_target)

include $(BUILD_PHONY_PACKAGE)

$(LOCAL_ADDITIONAL_DEPENDENCIES): PRIVATE_DRIVER_LOCAL_DIR_76x3 := $(local_path_full)
$(LOCAL_ADDITIONAL_DEPENDENCIES): $(INSTALLED_KERNEL_TARGET)
	$(hide) rm -rf $(PRIVATE_DRIVER_LOCAL_DIR_76x3)/.config
	$(hide) cp -f $(WIFI_PROJ_CONFIG_FILE_76x3) $(PRIVATE_DRIVER_LOCAL_DIR_76x3)/.config
	$(MAKE) -C $(KERNEL_OUT) M=$(PRIVATE_DRIVER_LOCAL_DIR_76x3) ARCH=$(TARGET_KERNEL_ARCH_76x3) CROSS_COMPILE=$(KERNEL_CROSS_COMPILE) CFG_MTK_PREALLOC_DRIVER=$(CFG_MTK_PREALLOC_DRIVER) modules
	$(MAKE) -C $(KERNEL_OUT) M=$(PRIVATE_DRIVER_LOCAL_DIR_76x3) ARCH=$(TARGET_KERNEL_ARCH_76x3) CROSS_COMPILE=$(KERNEL_CROSS_COMPILE) CFG_MTK_PREALLOC_DRIVER=$(CFG_MTK_PREALLOC_DRIVER) INSTALL_MOD_PATH=$(PRODUCT_OUT)/obj/KERNEL_OBJ modules_install
ifeq ($(MTK_STRIP_DRIVER), y)
	$(LOCAL_KERNEL_CROSS_COMPILE_76x3)strip -g $(PRIVATE_DRIVER_LOCAL_DIR_76x3)/$(WIFI_DRIVER_MODULE_NAME_IN_DRV_76x3).ko
	$(LOCAL_KERNEL_CROSS_COMPILE_76x3)strip -g $(PRIVATE_DRIVER_LOCAL_DIR_76x3)/$(WIFI_DRIVER_MODULE_NAME_IN_DRV_76x3)_prealloc.ko
endif
	$(hide) mkdir -p $(PRIVATE_DRIVER_OUT_DIR)
	$(hide) cp -f $(PRIVATE_DRIVER_LOCAL_DIR_76x3)/$(WIFI_DRIVER_MODULE_NAME_IN_DRV_76x3).ko $(PRIVATE_DRIVER_OUT_DIR)
ifeq ($(CFG_MTK_PREALLOC_DRIVER), y)
	$(hide) cp -f $(PRIVATE_DRIVER_LOCAL_DIR_76x3)/$(WIFI_DRIVER_MODULE_NAME_IN_DRV_76x3)_prealloc.ko $(PRIVATE_DRIVER_OUT_DIR)
endif
	$(MAKE) -C $(KERNEL_OUT) M=$(PRIVATE_DRIVER_LOCAL_DIR_76x3) ARCH=$(TARGET_KERNEL_ARCH_76x3) CROSS_COMPILE=$(KERNEL_CROSS_COMPILE) clean
local_path_full :=
wifi_module_out_path :=
wifi_module_target :=
